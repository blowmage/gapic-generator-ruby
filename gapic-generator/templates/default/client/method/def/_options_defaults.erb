<%- assert_locals method -%>
# Converts hash and nil to an options object
options = Google::Gax::ApiCall::Options.new options.to_h if options.respond_to? :to_h

# Customize the options with defaults
<%- if method.routing_params? -%>
header_params = {
<%- method.routing_params.each do |rp| -%>
  "<%= rp %>" => request.<%= rp %>,
<%- end -%>
}
request_params_header = header_params.map { |k, v| "#{k}=#{v}" }.join("&")
metadata = @metadata.merge "x-goog-request-params".freeze => request_params_header
<%- else -%>
metadata = @metadata.dup
<%- end -%>
<%- if method.retry_codes? -%>
retry_policy = {
  retry_codes: [
<%- method.retry_codes.each do |rc| -%>
    <%= rc %>,
<%- end -%>
  ]
}
<%- else -%>
retry_policy = {}
<%- end -%>
options.apply_defaults timeout: @timeout, metadata: metadata, retry_policy: retry_policy
