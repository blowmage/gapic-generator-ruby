<%- assert_locals method -%>
# Converts hash and nil to an options object
options = Gapic::CallOptions.new options.to_h if options.respond_to? :to_h

# Customize the options with defaults
metadata = @config.rpcs.<%= method.name %>.metadata.to_h

# Set x-goog-api-client header
metadata[:"x-goog-api-client"] ||= Gapic::Headers.x_goog_api_client \
  lib_name: @config.lib_name, lib_version: @config.lib_version,
  gapic_version: <%= method.service.gem.version_name_full %>
<%- if method.routing_params? -%>

header_params = {
<%- routing_params = method.routing_params.dup -%>
<%- last_routing_param = routing_params.pop -%>
<%- routing_params.each do |routing_param| -%>
  "<%= routing_param %>" => request.<%= routing_param %>,
<%- end -%>
  "<%= last_routing_param %>" => request.<%= last_routing_param %>
}
request_params_header = header_params.map { |k, v| "#{k}=#{v}" }.join("&")
metadata[:"x-goog-request-params"] ||= request_params_header
<%- end -%>

options.apply_defaults timeout:      @config.rpcs.<%= method.name %>.timeout,
                       metadata:     metadata,
                       retry_policy: @config.rpcs.<%= method.name %>.retry_policy
options.apply_defaults metadata:     @config.metadata,
                       retry_policy: @config.retry_policy
